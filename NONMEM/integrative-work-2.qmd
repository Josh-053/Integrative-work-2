---
title: "Integrative-work-2"
Authors: Joshua, Ali, Ante, Mike, Rawlings
format: html
editor: visual
---

```{r}
CEF <- read.table("IW2_Dataset_003_2526.txt", 
                  sep = " ",        # space-separated
                  na.strings = ".", # treat "." as NA
                  header = TRUE)
```

```{r}
library(tidyverse)
library(ggplot2)
library(patchwork)
library(smplot2)
library(mrgsolve)
```

```{r}
CEF <- CEF %>%
  mutate(BW = as.numeric(BW),
         ALB = as.numeric(ALB),
         eGFR = as.numeric(eGFR),
         DVID = as.integer(CONC_ID),
         DVID = ifelse(is.na(CONC_ID), 0, DVID),
         CMT = 1,
         MDV = ifelse(is.na(CONC), 1, 0),
         EVID = case_when(
           is.na(CONC) & DOSE!=0 ~ 1,
           CONC>=0 ~ 0,
           is.na(CONC) & DOSE==0 ~ 2))

CEF <- CEF %>% group_by(ID) %>%
  fill(c(BW),.direction = "downup") %>%
  fill(c(ALB),.direction = "downup") %>%
  fill(c(SCR),.direction = "downup") %>%
  fill(c(eGFR),.direction = "downup") %>%
  ungroup()

# CEF$ALBgL = CEF$ALB * 66500 * 0.001 # 65000 g/L; ALB (mmol/L or 1E-3 mol/L)
# CEF$AMT = CEF$DOSE * 600 / 1000 # 600 g/mol; mmol = 1E-3 mol; AMT in g
# CEF$DV = CEF$CONC * 600 / 1000 # DV in g/L


write.table(CEF, file = "dataset.txt", quote = FALSE, sep = " ", na = ".")
write.csv(CEF,file = "dataset.csv", quote = FALSE, row.names = FALSE, na = ".")
```

```{r}
## check %BLQ
conc1 <- na.omit(CEF$CONC[CEF$CONC_ID==1]) # omit missing values from the concentrations
LLOQ1 <- 0.001 # given: LLOQ = 0.001 mmol/L for total conc.
perc_BLQ1 <- mean(conc1 < LLOQ1) * 100
perc_BLQ1

conc2 <- na.omit(CEF$CONC[CEF$CONC_ID==2])
LLOQ2 <- 0.0001 # given: LLOQ = 0.0001 mmol/L for unbound conc.
perc_BLQ2 <- mean(conc2 < LLOQ2) * 100
perc_BLQ2
```

No missing data was observed below LLOQ! -\> ask about LLOQ to verify with Emanuel

```{r}
h1 <- ggplot(CEF, aes(x = AGE)) +
      geom_histogram(binwidth = 2,
                     fill = "white", color = "black") +
      labs(x = "Age (years)",
           y = "Frequency") +
      theme_minimal()
h2 <- ggplot(CEF, aes(x = ALB)) +
      geom_histogram(binwidth = 0.025,
                     fill = "white", color = "black") +
      labs(x = "Albumin Conc. (g/L) at Time = 0 h",
           y = "Frequency") +
      theme_minimal()
h3 <- ggplot(CEF, aes(x = BW)) +
      geom_histogram(binwidth = 4,
                     fill = "white", color = "black") +
      labs(x = "Body Weight (kg)",
           y = "Frequency") +
      theme_minimal()
h4 <- ggplot(CEF, aes(x = SCR)) +
      geom_histogram(binwidth = 0.1,
                     fill = "white", color = "black") +
      labs(x = "Serum Creatinine Conc. (mg/dL)",
           y = "Frequency") +
      theme_minimal()
h6 <- ggplot(CEF, aes(x = eGFR)) +
      geom_histogram(binwidth = 6,
                     fill = "white", color = "black") +
      labs(x = "eGFR (mL/min/1.73 mÂ²)",
           y = "Frequency")+
      theme_minimal()

h1 + h2 + h3 + h4 + h6 + plot_layout(ncol = 2)
```


```{r}
ggplot(CEF,
       aes(x = eGFR,
           y = SCR)) +
  geom_point(size = 0.5) +
  stat_summary(line = "mean")
```

ask emanuel about PR (ID = 7, PR goes from 1 to 0 and 0 to 1) -\> healed or not, ask emanuel about sex: pk-pattern shows inverted observations from phase I -\> body weight, eGFR


```{r}
dat <- read.table (file='run02', skip=1, header=T)
ggplot (dat, aes(x = eGFR,
                 y = ETA1)) +
  geom_point (color='blue') +
  sm_statCorr(corr_method = "spearman", color = "black")
```

```{r}
dat <- read.table (file='run02', skip=1, header=T)
ggplot (dat, aes(x = BW,
                 y = ETA1)) +
  geom_point (color='blue') +
  sm_statCorr(corr_method = "spearman", color = "black")
```

```{r}
sim <- read.table (file="run06", skip=1, header=T)

sim_summary <- sim %>%
  group_by(TIME) %>%
  summarise(
    p5 = quantile(IPRED, 0.05),
    p50 = quantile(IPRED, 0.50),
    p95 = quantile(IPRED, 0.95)
  )

obs_summary <- dat %>%
  group_by(TIME) %>%
  summarise(obs_median = median(CONC))

vpc_data <- left_join(sim_summary, obs_summary, by = "TIME")

ggplot(vpc_data, aes(x = TIME)) +
  geom_ribbon(aes(ymin = p5, ymax = p95), fill = "lightblue", alpha = 0.4) +
  geom_line(aes(y = p50), color = "blue", size = 1) +
  geom_point(aes(y = obs_median), color = "red", size = 2) +
  labs(title = "Visual Predictive Check",
       x = "Time (h)", y = "Concentration") +
  theme_minimal()
```

```{r}
library(ggpubr)

# Boxplot with violin plot
run02 <- read.table (file="run02", skip=1, header=T)

ggplot(run02, aes(x = PR, y = CL, fill = as.factor(PR))) +
  geom_boxplot(width=0.1, outlier.shape = NA) +
  geom_violin(alpha = 0.3,
              trim = FALSE) +
  stat_compare_means(
    method = "wilcox.test",    # Non-parametric test (Mann-Whitney)
    label = "p.format",         # show p-value (use "p.signif" for stars)
    label.x = 1.5
  ) +
  labs(title = "Clearance vs Pneumonia Remission",
       x = "Remission Status",
       y = "Clearance (L/h)") +
  theme_minimal() +
  theme(legend.position = "none")
 
```

# calculating the fraction unbound

```{r}

total <- CEF %>%
  filter(CONC_ID == 1) %>%
  select(ID, TIME, total = CONC)

unbound <- CEF %>%
  filter(CONC_ID == 2) %>%
  select(ID, TIME, unbound = CONC)

fu_by_time <- total %>%
  inner_join(unbound, by = c("ID", "TIME")) %>%
  mutate(
    fu = case_when(
      is.na(total) | is.na(unbound) ~ NA_real_,
      total == 0 ~ NA_real_,
      TRUE ~ unbound / total
    )
  )

ggplot(fu_by_time, aes(x = fu)) +
  geom_histogram()
```

