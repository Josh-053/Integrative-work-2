---
title: "Untitled"
format: html
---

```{r packages}
#| echo: true

if (!require("pacman")) {
  install.packages("pacman")
  library(pacman)}

pacman::p_load(mrgsolve,
               ggplot2,
               tidyverse,
               patchwork)
```

```{r}
#| echo: false
mod <- mread("run03")
```

```{r}
#| echo: false
mod %>%
  ev(amt = 2000) %>% 
  mrgsim() %>% 
  plot()
```
# Assume you already have your two-compartment infusion model compiled as 'mod'
# Example: mod <- mread("twocpt_infusion", "path/to/model")

# Parameters
```{r}
MIC <- 0.5            # mg/L (typical for S. pneumoniae)
fu  <- 0.1560871      # fraction unbound, median of Phase 2 study
tau <- 24             # dosing interval (hours)
```

# Simulate one interval at steady state
```{r}
out <- mod %>%
  ev(amt = 2000, ii = tau, addl = 10, rate = 2000/0.5) %>% # 2 g over 0.5 h, q12h
  mrgsim(end = tau, delta = 0.01)                          # fine grid
```

# Compute free concentrations

```{r}
out <- out %>%
  mutate(Cfree = IPRED * fu,                # CP = central compartment conc
         aboveMIC = Cfree > MIC)
```

# Calculate fT>MIC
```{r}
ft_mic <- sum(out$aboveMIC) * 0.01 / tau * 100
ft_mic
```
# Multiple dosing events

```{r}
e1 <- ev(amt = 2000) #loading dose
e2 <- ev(amt = 2000, cmt = 1,
         rate = 0.5,
         time = 24, 
         ii = 24,
         addl = 1) 
e <-c(e1,e2)
```

```{r}
mod %>% 
  ev(e) %>% 
  mrgsim(end=80, 
         delta=0.05) %>% 
  plot()
```

# Set EPS(1) variance to 0.03294046 (1Ã—1 SIGMA)

```{r}
mod <- update(mod, sigma = matrix(0.03294046, nrow = 1))
smat(mod) 

mod %>% 
  ev(amt = 2000) %>% 
  mrgsim(delta=0.05) %>% 
  plot(DV~time,
       col = "darkred",
       type = "p",
       main = "Simulated Pk profile (ID: 1)",
       ylab = "Plasma concentration (mg/L)",
       xlab = "Time (h)") 
```
```{r}
mod %>%
  ev(amt = 2000) %>% 
  mrgsim(nid = 20,
         delta=0.05) -> res

ggplot(as.data.frame(res), 
       aes(x = time, y = DV,
           color = as.factor(ID))) +
  geom_line(size = 0.3) +
  labs(x = "Time (h)", 
       y = "Plasma concentration (mg/L)", 
       title = "Simulated Pk profiles (for one patient)") 

```
